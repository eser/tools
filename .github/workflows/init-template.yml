name: Initialize Template

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  init:
    # Only run on first push (when repo is created from template)
    if: github.run_number == 1
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Replace placeholders
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_DESCRIPTION: ${{ github.event.repository.description }}
          REPO_URL: ${{ github.event.repository.html_url }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          # Replace placeholders in all files
          find . -type f \( -name "*.md" -o -name "*.yml" -o -name "*.yaml" -o -name "CODEOWNERS" \) \
            -not -path "./.git/*" \
            -not -name "init-template.yml" \
            -exec sed -i \
              -e "s|{{PROJECT_NAME}}|${REPO_NAME}|g" \
              -e "s|{{PROJECT_DESCRIPTION}}|${REPO_DESCRIPTION}|g" \
              -e "s|{{REPO_URL}}|${REPO_URL}|g" \
              -e "s|{{GITHUB_USERNAME}}|${REPO_OWNER}|g" \
              {} +

      - name: Remove init workflow
        run: rm -f .github/workflows/init-template.yml

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: initialize repository from template"
          git push
